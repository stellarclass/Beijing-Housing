---
title: "R Notebook"
output: html_notebook
---

```{r warning=FALSE,message=FALSE}
library(plyr)
library(dplyr)
library(Hmisc)
library(ggpubr)
library(DMwR)
library(caret)
library(pROC)
library(ggplot2)
library(ggpubr)
library(stringr)
set.seed(42)
model_dir = "models"
data_dir = "data"
```


 - **url**:  the url which fetches the data
 - **id**:  the id of transaction
 - **Lng**:  and **Lat**  coordinates, using the **BD09** protocol. 
 - **Cid**:  community id
 - **tradeTime**:  the time of transaction
 - **DOM**:  active days on market.Know more in https://en.wikipedia.org/wiki/Days_on_market
 - **followers**:  the number of people follow the transaction.
 - **totalPrice**:  the total price in multiple of 10,000
 - **price**:  the average price by square
 - **square**:  the square of house
 - **livingRoom**:   the number of living room
 - **drawingRoom**:  the number of drawing room
 - **kitchen**:  the number of kitchen
 - **bathroom** the number of bathroom
 - **floor**:  the height of the house. I will turn the Chinese characters to English in the next version.
 - **buildingType**:  including tower( 1 ) , bungalow( 2 )ï¼Œcombination of plate and tower( 3 ), plate( 4 ).
 - **constructionTime**:  the time of construction
 - **renovationCondition**: including other( 1 ), rough( 2 ),Simplicity( 3 ), hardcover( 4 )
 - **buildingStructure**: including unknow( 1 ), mixed( 2 ), brick and wood( 3 ), brick and concrete( 4 ),steel( 5 ) and steel-concrete composite ( 6 ).
 - **ladderRatio**:  the proportion between number of residents on the same floor and number of elevator of ladder. It describes how many ladders a resident have on average.
 - **elevator** have ( 1 ) or not have elevator( 0 )
 - **fiveYearsProperty**:  if the owner have the property for less than 5 years, 

```{r}
### Loading data
data=read.csv(paste(data_dir,"new.csv",sep="/"), header = TRUE, sep = ",",na.strings = c("nan","unknown","#NAME?"), fileEncoding="latin1")

#Probably a crawler problem
data$drawingRoom <- as.integer(gsub("[a-z]+\\s\\d+", NA, data$drawingRoom))
data$constructionTime[which(data$constructionTime==1)] = NA
data$constructionTime[which(data$constructionTime==0)] = NA
data$bathRoom[which(data$bathRoom>100)] = NA # You cannot have that many bathrooms!
#building type has decimal places when it should not - change to NA
data$buildingType[which(data$buildingType<1)] = NA
#split floor to have height info 
temp <- as.data.frame(str_split_fixed(data$floor, " ", 2))
colnames(temp) <- c("floorType", "floorLevel")
data <- cbind(data, temp)
#factor elevator, fiveyearsproperty, subway and change to yes/no
data$elevator = factor(mapvalues(data$elevator, from = c(0, 1), to = c("no", "yes")))
data$fiveYearsProperty = factor(mapvalues(data$fiveYearsProperty, from = c(0, 1), to = c("no", "yes")))
data$subway = factor(mapvalues(data$subway, from = c(0, 1), to = c("no", "yes")))
#factor building type, kitchen
data$buildingType <- as.factor(data$buildingType)
data$kitchen <- as.factor(mapvalues(data$kitchen, from = c(0, 1), to = c("no", "yes")))
data$district <- as.factor(data$district)
#remove unused columnns
data <- data[, !colnames(data) %in% c("url","id", "floor")]

apply(data,2,function(x){sum(is.na(x))/length(x)*100})
```

```{r}
set.seed(42)
split = createDataPartition(data$price, times = 1, p=0.2, list = F)
train = data[split,]
test = data[-split,]
folds <- createFolds(train$price, k = 5)
myControl <- trainControl(
  method = "cv",
  index = folds,
  verboseIter = F
)
```


```{r}
model_rpart <- caret::train(
  price ~ ., train,
  metric = "RMSE",
  method = "rpart",
  trControl = myControl,
  tuneGrid = expand.grid(
    cp = seq(0.01,0.001)
  ),
  na.action = na.omit
)
```

